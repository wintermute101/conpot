FROM alpine:3.8 as conpot-builder

ENV http_proxy=http://sproxy-de.corp.vattenfall.com:8086
ENV https_proxy=http://sproxy-de.corp.vattenfall.com:8086
ENV no_proxy=127.0.0.1

# Install dependencies
RUN apk add --no-cache ipmitool tcpdump git python3-dev build-base wget py-cffi libxslt-dev openssl-dev

# Copy the app from the host folder (probably a cloned repo) to the container
RUN adduser -s /bin/ash -D conpot
WORKDIR /opt/
RUN git clone --depth=1 https://github.com/mushorg/conpot.git
RUN chown conpot:conpot -R /opt/conpot

# Install Python requirements
USER conpot
WORKDIR /opt/conpot
RUN pip3 install --user --no-cache-dir -U pip setuptools
RUN pip3 install --user --no-cache-dir coverage
RUN pip3 install --user --no-cache-dir -r requirements.txt

# Install the Conpot application
RUN python3 setup.py install --user --prefix=

# Run test cases
ENV PATH=$PATH:/home/conpot/.local/bin
RUN py.test -v

RUN pip3 uninstall -y setuptools

WORKDIR /home/conpot
RUN tar -zcf conpot.tgz .local

FROM alpine:3.8

USER root

ENV http_proxy=http://sproxy-de.corp.vattenfall.com:8086
ENV https_proxy=http://sproxy-de.corp.vattenfall.com:8086
ENV no_proxy=127.0.0.1

RUN apk add --no-cache ipmitool ca-certificates tcpdump python3 wget py-cffi libxslt openssl

RUN adduser -s /bin/ash -D conpot
WORKDIR /home/conpot
COPY --from=conpot-builder /home/conpot/conpot.tgz /home/conpot
RUN tar -zxf conpot.tgz && rm conpot.tgz
RUN mkdir -p /etc/conpot /var/log/conpot /usr/share/wireshark && \
    wget https://github.com/wireshark/wireshark/raw/master/manuf -o /usr/share/wireshark/manuf

# Create directories
RUN mkdir -p /var/log/conpot/
RUN mkdir -p /data/tftp/
RUN chown conpot:conpot /var/log/conpot
RUN chown conpot:conpot -R /data

# Clean
RUN apk del --purge wget ca-certificates

USER conpot
WORKDIR /home/conpot
ENV USER=conpot

CMD ["/home/conpot/.local/bin/conpot", "--template", "default", "--logfile", "/var/log/conpot/conpot.log", "-f", "--temp_dir", "/tmp" ]
